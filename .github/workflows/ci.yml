# =============================================================================
# CodeRunner CI/CD Pipeline
# =============================================================================
#
# This workflow runs on every push and pull request to ensure code quality,
# and automatically releases when tests pass on main.
#
# Jobs:
#   - test: Run unit tests and linting
#   - integration-test: Run Docker-based integration tests
#   - validate-infrastructure: Validate Bicep templates
#   - build-release: Build and release deploy.zip (main branch only)
#
# The Bicep template uses releases/latest/download/deploy.zip, so every
# successful merge to main automatically updates the deployment package.
#
# =============================================================================

name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov

      - name: Run unit tests
        run: |
          pytest tests/unit/ -v --cov=function_app --cov-report=term-missing

      - name: Check code style
        run: |
          pip install flake8
          flake8 function_app.py --max-line-length=120 --ignore=E501,W503

  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and run integration tests
        run: |
          docker compose -f docker/docker-compose.yml up \
            --build \
            --abort-on-container-exit \
            --exit-code-from test-runner
        timeout-minutes: 15

      - name: Collect test logs on failure
        if: failure()
        run: |
          docker compose -f docker/docker-compose.yml logs coderunner > coderunner.log 2>&1 || true
          docker compose -f docker/docker-compose.yml logs test-runner > test-runner.log 2>&1 || true

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-logs
          path: |
            coderunner.log
            test-runner.log

      - name: Cleanup
        if: always()
        run: docker compose -f docker/docker-compose.yml down -v

  validate-infrastructure:
    name: Validate Infrastructure
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate Bicep templates
        run: |
          echo "Validating main.bicep..."
          az bicep build --file infra/main.bicep --stdout > /dev/null
          echo "âœ… main.bicep is valid"

  # Build and release deployment package
  # Only runs on push to main after all tests pass
  build-release:
    name: Build & Release
    runs-on: ubuntu-latest
    needs: [test, integration-test, validate-infrastructure]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Create build directory
        run: |
          mkdir -p build/.python_packages/lib/site-packages
          mkdir -p build/.matplotlib

      - name: Copy application files
        run: |
          cp function_app.py build/
          cp host.json build/
          cp requirements.txt build/
          cp -r src build/

      - name: Install bundled packages
        run: |
          pip install --target build/.python_packages/lib/site-packages \
            numpy pandas scipy scikit-learn matplotlib \
            requests httpx beautifulsoup4 \
            pyyaml toml python-dateutil tqdm pillow \
            --quiet

      - name: Generate matplotlib font cache
        run: |
          export MPLCONFIGDIR=${{ github.workspace }}/build/.matplotlib
          python -c "
          import matplotlib
          matplotlib.use('Agg')
          from matplotlib import font_manager
          print(f'Font cache generated with {len(font_manager.fontManager.ttflist)} fonts')
          "
          ls -la build/.matplotlib/

      - name: Create deploy.zip
        run: |
          cd build
          zip -rq ../deploy.zip .
          cd ..
          echo "Package size: $(du -h deploy.zip | cut -f1)"

      - name: Delete existing latest release
        run: |
          gh release delete latest --yes --cleanup-tag || true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create release
        run: |
          gh release create latest deploy.zip \
            --title "Latest Release" \
            --notes "Automated build from commit $(echo ${{ github.sha }} | cut -c1-7)

          **Pre-installed packages:**
          - numpy, pandas, scipy, scikit-learn
          - matplotlib (with bundled font cache)
          - requests, httpx, beautifulsoup4
          - pyyaml, toml, python-dateutil, tqdm, pillow

          Built with Python 3.11 for Azure Functions."
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
